// ============================================================================
// PROVIDER: ImportProvider - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
// ============================================================================
// –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ Excel
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ ImportRow, —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—ã–±–æ—Ä–æ–º —Å—Ç—Ä–æ–∫,
//               –≤–∞–ª–∏–¥–∞—Ü–∏–∏, –ø–æ–∏—Å–∫–∞ –¥—É–±–ª–µ–π –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
// –ü–∞—Ç—Ç–µ—Ä–Ω: Provider (State Management)


import 'package:flutter/foundation.dart';
import '../models/import_row_model.dart';
import '../services/excel_import_service.dart';
import '../services/api_service.dart';


class ImportProvider with ChangeNotifier {
  // =========================================================================
  // –ü–†–ò–í–ê–¢–ù–´–ï –ü–û–õ–Ø (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
  // =========================================================================


  List<ImportRow> _importedRows = []; // –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫
  bool _isLoading = false; // –§–ª–∞–≥: –∏–¥—ë—Ç –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
  bool _isUploading = false; // –§–ª–∞–≥: –∏–¥—ë—Ç –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
  String? _errorMessage; // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)


  // =========================================================================
  // –°–û–ó–î–ê–ù–ò–ï –≠–ö–ó–ï–ú–ü–õ–Ø–†–ê ApiService
  // =========================================================================
  // ‚úÖ –ù–û–í–û–ï: –°–æ–∑–¥–∞—ë–º —ç–∫–∑–µ–º–ø–ª—è—Ä ApiService –¥–ª—è –≤—ã–∑–æ–≤–∞ –º–µ—Ç–æ–¥–∞ post()
  // –†–∞–Ω—å—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –º–µ—Ç–æ–¥ uploadOrders(), —Ç–µ–ø–µ—Ä—å - –æ–±—ã—á–Ω—ã–π post()
  final ApiService _apiService = ApiService();


  // =========================================================================
  // –ü–£–ë–õ–ò–ß–ù–´–ï –ì–ï–¢–¢–ï–†–´ (–¥–æ—Å—Ç—É–ø –∫ —Å–æ—Å—Ç–æ—è–Ω–∏—é)
  // =========================================================================


  List<ImportRow> get importedRows => _importedRows;
  bool get isLoading => _isLoading;
  bool get isUploading => _isUploading;
  String? get errorMessage => _errorMessage;


  // -------------------------------------------------------------------------
  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫
  // -------------------------------------------------------------------------
  int get totalCount => _importedRows.length;


  // -------------------------------------------------------------------------
  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞–ª–∏–¥–Ω—ã—Ö —Å—Ç—Ä–æ–∫ (–±–µ–∑ –æ—à–∏–±–æ–∫)
  // -------------------------------------------------------------------------
  int get validCount => _importedRows.where((row) => row.error == null).length;


  // -------------------------------------------------------------------------
  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ —Å –æ—à–∏–±–∫–∞–º–∏
  // -------------------------------------------------------------------------
  int get errorCount => _importedRows.where((row) => row.error != null).length;


  // -------------------------------------------------------------------------
  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥—É–±–ª–µ–π
  // -------------------------------------------------------------------------
  int get duplicateCount =>
      _importedRows.where((row) => row.isDuplicate).length;


  // -------------------------------------------------------------------------
  // ‚úÖ –ù–û–í–û–ï: –°–ø–∏—Å–æ–∫ —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã—Ö —Å—Ç—Ä–æ–∫ (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)
  // -------------------------------------------------------------------------
  List<ImportRow> get validRows =>
      _importedRows.where((row) => row.error == null).toList();


  // =========================================================================
  // –ú–ï–¢–û–î: –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å Excel —Ñ–∞–π–ª
  // =========================================================================
  // fileBytes - –±–∞–π—Ç—ã —Ñ–∞–π–ª–∞ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –Ω–∞ Web)
  // columnMapping - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞–ø–ø–∏–Ω–≥–∞ –∫–æ–ª–æ–Ω–æ–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)


  Future<void> loadExcelFile({
    required List<int> fileBytes,
    required dynamic columnMapping,
  }) async {
    try {
      _isLoading = true;
      _errorMessage = null;
      notifyListeners();


      debugPrint('üìÇ ImportProvider: –ù–∞—á–∏–Ω–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥ —Ñ–∞–π–ª–∞...');


      // –ü–∞—Ä—Å–∏–º —Ñ–∞–π–ª —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å
      final rows = await ExcelImportService.parseExcelFile(
        fileBytes: fileBytes,
        columnMapping: columnMapping,
        dataStartRowIndex: columnMapping?.dataStartRowIndex ?? 1,
      );


      // –ò—â–µ–º –¥—É–±–ª–∏
      final duplicates = ExcelImportService.findDuplicates(rows);


      // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–æ–º–µ—á–∞–µ–º –¥—É–±–ª–∏ —á–µ—Ä–µ–∑ copyWith() –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏—è
      // –ü—Ä–æ–±–ª–µ–º–∞: isDuplicate - final –ø–æ–ª–µ, –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é
      // –†–µ—à–µ–Ω–∏–µ: –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç —Å –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–º –ø–æ–ª–µ–º
      for (var key in duplicates.keys) {
        for (int i = 0; i < rows.length; i++) {
          if (duplicates[key]!.contains(rows[i])) {
            rows[i] = rows[i].copyWith(isDuplicate: true);
          }
        }
      }


      _importedRows = rows;
      _isLoading = false;


      debugPrint('‚úÖ ImportProvider: –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${_importedRows.length} —Å—Ç—Ä–æ–∫');
      debugPrint(
          '   –í–∞–ª–∏–¥–Ω—ã—Ö: $validCount | –û—à–∏–±–æ–∫: $errorCount | –î—É–±–ª–µ–π: $duplicateCount');


      notifyListeners();
    } catch (e) {
      _isLoading = false;
      _errorMessage = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: $e';
      debugPrint('‚ùå ImportProvider: $_errorMessage');
      notifyListeners();
      rethrow;
    }
  }


  // =========================================================================
  // ‚úÖ –ù–û–í–´–ô –ú–ï–¢–û–î: –í—ã–±—Ä–∞—Ç—å –≤—Å–µ –≤–∞–ª–∏–¥–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
  // =========================================================================
  // (–≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ, –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è —á–µ–∫–±–æ–∫—Å—ã)


  // =========================================================================
  // ‚úÖ –ù–û–í–´–ô –ú–ï–¢–û–î: –°–Ω—è—Ç—å –≤—ã–±–æ—Ä —Å–æ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
  // =========================================================================
  // (–≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ, –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è —á–µ–∫–±–æ–∫—Å—ã)


  // =========================================================================
  // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ú–ï–¢–û–î: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¢–û–õ–¨–ö–û –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
  // =========================================================================
  // –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –û—Ç–ø—Ä–∞–≤–∫–∞ –≤–∞–ª–∏–¥–Ω—ã—Ö —Å—Ç—Ä–æ–∫ –Ω–∞ endpoint /api/orders/import-aggregated
  // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç: ApiService.post() –≤–º–µ—Å—Ç–æ —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ uploadOrders()
  // –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö: { "installers": [ {"fullName": "...", "orderAmount": 123.45}, ... ] }


  Future<void> uploadSelectedToServer() async {
    try {
      _isUploading = true;
      _errorMessage = null;
      notifyListeners();


      // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
      final rowsToUpload = validRows; // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –í–°–ï –≤–∞–ª–∏–¥–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏


      if (rowsToUpload.isEmpty) {
        throw Exception('–ù–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π –≤–∞–ª–∏–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏!');
      }


      debugPrint(
          'üì§ ImportProvider: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ${rowsToUpload.length} –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');


      // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ post()
      // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è endpoint /api/orders/import-aggregated
      // –û–∂–∏–¥–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–µ—Ä–≤–µ—Ä–∞: { "installers": [ {"fullName": "...", "orderAmount": 123.45}, ... ] }
      final data = {
        'installers': rowsToUpload.map((row) {
          return {
            'fullName': row.fullName,        // –§–ò–û –º–æ–Ω—Ç–∞–∂–Ω–∏–∫–∞
            'orderAmount': row.orderAmount,  // –û–±—â–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞
          };
        }).toList(),
      };


      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ ApiService.post()
      final response = await _apiService.post('/api/orders/import-aggregated', data);


      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞
      if (response['status'] == 'success') {
        final usersCreated = response['usersCreated'] ?? 0;
        final ordersCreated = response['ordersCreated'] ?? 0;
        
        debugPrint('‚úÖ ImportProvider: –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!');
        debugPrint('   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ–∑–¥–∞–Ω–æ: $usersCreated');
        debugPrint('   - –ó–∞–∫–∞–∑–æ–≤ —Å–æ–∑–¥–∞–Ω–æ: $ordersCreated');
      } else {
        throw Exception('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response['message']}');
      }


      _isUploading = false;
      notifyListeners();
    } catch (e) {
      _isUploading = false;
      _errorMessage = '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: $e';
      debugPrint('‚ùå ImportProvider: $_errorMessage');
      notifyListeners();
      rethrow;
    }
  }


  // =========================================================================
  // –ú–ï–¢–û–î: –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
  // =========================================================================


  void clear() {
    _importedRows = [];
    _isLoading = false;
    _isUploading = false;
    _errorMessage = null;
    debugPrint('üóëÔ∏è ImportProvider: –î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã');
    notifyListeners();
  }
}
